services:
  icecast:
    image: libretime/icecast:2.4.4
    container_name: radio_icecast
    volumes:
      - ./icecast.xml:/etc/icecast2/icecast.xml:ro
    ports:
      - "8000:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8000 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10

  mpd:
    build: ./mpd
    container_name: radio_mpd
    depends_on:
      - icecast
    environment:
      - MPD_MUSIC=/music
    volumes:
      - ./music:/music:ro
      - mpd-data:/var/lib/mpd
      - mpd-playlists:/playlists
    # TEMP: expose to host for testing; remove later if you want
    ports:
      - "6600:6600"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mpc -h localhost -p 6600 status >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10

  ympd:
    image: giof71/ympd:latest
    container_name: radio_ympd
    depends_on:
      mpd:
        condition: service_healthy
    environment:
      - YMPD_MPD_SERVER=mpd
      - YMPD_MPD_PORT=6600
    ports:
      - "8081:80"
    restart: unless-stopped

volumes:
  mpd-data:
  mpd-playlists:
